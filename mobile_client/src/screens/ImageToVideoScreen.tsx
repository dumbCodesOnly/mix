import React, { useState } from 'react';\nimport {\n  View,\n  Text,\n  TextInput,\n  TouchableOpacity,\n  ScrollView,\n  ActivityIndicator,\n  Alert,\n  StyleSheet,\n  Image,\n} from 'react-native';\nimport * as ImagePicker from 'expo-image-picker';\nimport { getAPIClient } from '../services/api';\nimport { getCacheService } from '../services/cache';\n\ninterface ImageToVideoParams {\n  image: string;\n  model?: string;\n  prompt?: string;\n  duration: number;\n  fps: number;\n  num_inference_steps: number;\n}\n\nconst ImageToVideoScreen: React.FC = () => {\n  const [selectedImage, setSelectedImage] = useState<string | null>(null);\n  const [imageBase64, setImageBase64] = useState<string | null>(null);\n  const [prompt, setPrompt] = useState('');\n  const [model, setModel] = useState('');\n  const [duration, setDuration] = useState('6');\n  const [fps, setFps] = useState('8');\n  const [steps, setSteps] = useState('50');\n  const [loading, setLoading] = useState(false);\n  const [videoUri, setVideoUri] = useState<string | null>(null);\n  const [generationTime, setGenerationTime] = useState<number | null>(null);\n\n  const apiClient = getAPIClient();\n  const cacheService = getCacheService();\n\n  const handlePickImage = async () => {\n    try {\n      const result = await ImagePicker.launchImageLibraryAsync({\n        mediaTypes: ImagePicker.MediaTypeOptions.Images,\n        allowsEditing: false,\n        aspect: [1, 1],\n        quality: 0.8,\n        base64: true,\n      });\n\n      if (!result.canceled && result.assets[0]) {\n        const asset = result.assets[0];\n        setSelectedImage(asset.uri);\n        if (asset.base64) {\n          setImageBase64(asset.base64);\n        }\n      }\n    } catch (error) {\n      console.error('Error picking image:', error);\n      Alert.alert('Error', 'Failed to pick image');\n    }\n  };\n\n  const handleGenerateVideo = async () => {\n    if (!imageBase64) {\n      Alert.alert('Error', 'Please select an image');\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const params: ImageToVideoParams = {\n        image: imageBase64,\n        duration: parseInt(duration),\n        fps: parseInt(fps),\n        num_inference_steps: parseInt(steps),\n      };\n\n      if (model) params.model = model;\n      if (prompt) params.prompt = prompt;\n\n      const startTime = Date.now();\n      const videoBlob = await apiClient.generateImageToVideo(params);\n      const endTime = Date.now();\n\n      setGenerationTime((endTime - startTime) / 1000);\n\n      // Cache the video\n      const cacheKey = `video_${Date.now()}`;\n      const cachedUri = await cacheService.cacheVideo(cacheKey, videoBlob);\n      setVideoUri(cachedUri);\n\n      Alert.alert('Success', 'Video generated successfully!');\n    } catch (error) {\n      console.error('Error generating video:', error);\n      Alert.alert('Error', 'Failed to generate video. Please try again.');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleClearResults = () => {\n    setVideoUri(null);\n    setGenerationTime(null);\n  };\n\n  const handleClearImage = () => {\n    setSelectedImage(null);\n    setImageBase64(null);\n  };\n\n  return (\n    <ScrollView style={styles.container}>\n      <Text style={styles.title}>Image-to-Video Generation</Text>\n\n      {/* Image Selection */}\n      <View style={styles.section}>\n        <Text style={styles.label}>Select Image *</Text>\n        {selectedImage ? (\n          <View style={styles.imageContainer}>\n            <Image source={{ uri: selectedImage }} style={styles.image} />\n            <TouchableOpacity\n              style={styles.removeButton}\n              onPress={handleClearImage}\n            >\n              <Text style={styles.removeButtonText}>Remove</Text>\n            </TouchableOpacity>\n          </View>\n        ) : (\n          <TouchableOpacity\n            style={styles.imagePicker}\n            onPress={handlePickImage}\n            disabled={loading}\n          >\n            <Text style={styles.imagePickerText}>ðŸ“¸ Pick Image</Text>\n          </TouchableOpacity>\n        )}\n      </View>\n\n      {/* Prompt Input */}\n      <View style={styles.section}>\n        <Text style={styles.label}>Video Style Prompt (Optional)</Text>\n        <TextInput\n          style={[styles.input, styles.multilineInput]}\n          placeholder=\"Describe how the image should move (e.g., 'cinematic camera movement')\"\n          value={prompt}\n          onChangeText={setPrompt}\n          multiline\n          editable={!loading}\n          maxLength={500}\n        />\n        <Text style={styles.charCount}>{prompt.length}/500</Text>\n      </View>\n\n      {/* Model Selection */}\n      <View style={styles.section}>\n        <Text style={styles.label}>Model (Optional)</Text>\n        <TextInput\n          style={styles.input}\n          placeholder=\"e.g., stabilityai/stable-video-diffusion-img2vid\"\n          value={model}\n          onChangeText={setModel}\n          editable={!loading}\n        />\n        <Text style={styles.hint}>\n          Leave empty to use default model\n        </Text>\n      </View>\n\n      {/* Video Parameters */}\n      <View style={styles.section}>\n        <Text style={styles.label}>Video Parameters</Text>\n\n        <View style={styles.paramRow}>\n          <View style={styles.paramField}>\n            <Text style={styles.paramLabel}>Duration (seconds)</Text>\n            <TextInput\n              style={styles.paramInput}\n              placeholder=\"6\"\n              value={duration}\n              onChangeText={setDuration}\n              keyboardType=\"numeric\"\n              editable={!loading}\n            />\n            <Text style={styles.paramHint}>1-30</Text>\n          </View>\n\n          <View style={styles.paramField}>\n            <Text style={styles.paramLabel}>FPS</Text>\n            <TextInput\n              style={styles.paramInput}\n              placeholder=\"8\"\n              value={fps}\n              onChangeText={setFps}\n              keyboardType=\"numeric\"\n              editable={!loading}\n            />\n            <Text style={styles.paramHint}>1-60</Text>\n          </View>\n        </View>\n\n        <View style={styles.paramRow}>\n          <View style={styles.paramField}>\n            <Text style={styles.paramLabel}>Inference Steps</Text>\n            <TextInput\n              style={styles.paramInput}\n              placeholder=\"50\"\n              value={steps}\n              onChangeText={setSteps}\n              keyboardType=\"numeric\"\n              editable={!loading}\n            />\n            <Text style={styles.paramHint}>1-100</Text>\n          </View>\n        </View>\n      </View>\n\n      {/* Generate Button */}\n      <TouchableOpacity\n        style={[styles.button, (loading || !imageBase64) && styles.buttonDisabled]}\n        onPress={handleGenerateVideo}\n        disabled={loading || !imageBase64}\n      >\n        {loading ? (\n          <ActivityIndicator color=\"#fff\" />\n        ) : (\n          <Text style={styles.buttonText}>Generate Video</Text>\n        )}\n      </TouchableOpacity>\n\n      {/* Generation Time */}\n      {generationTime !== null && (\n        <View style={styles.infoBox}>\n          <Text style={styles.infoText}>\n            Generation Time: {generationTime.toFixed(2)}s\n          </Text>\n        </View>\n      )}\n\n      {/* Clear Results Button */}\n      {videoUri && (\n        <TouchableOpacity\n          style={[styles.button, styles.secondaryButton]}\n          onPress={handleClearResults}\n        >\n          <Text style={styles.secondaryButtonText}>Clear Results</Text>\n        </TouchableOpacity>\n      )}\n\n      {/* Info Section */}\n      <View style={styles.infoSection}>\n        <Text style={styles.infoTitle}>Tips for Best Results</Text>\n        <Text style={styles.infoItem}>\n          â€¢ Use clear, well-lit images for best results\n        </Text>\n        <Text style={styles.infoItem}>\n          â€¢ Square images (1:1 aspect ratio) work best\n        </Text>\n        <Text style={styles.infoItem}>\n          â€¢ Optional prompt helps guide the video generation style\n        </Text>\n        <Text style={styles.infoItem}>\n          â€¢ Higher inference steps = better quality but slower generation\n        </Text>\n      </View>\n    </ScrollView>\n  );\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#f5f5f5',\n    padding: 16,\n  },\n  title: {\n    fontSize: 24,\n    fontWeight: 'bold',\n    marginBottom: 20,\n    color: '#333',\n  },\n  section: {\n    marginBottom: 20,\n    backgroundColor: '#fff',\n    padding: 16,\n    borderRadius: 8,\n  },\n  label: {\n    fontSize: 16,\n    fontWeight: '600',\n    marginBottom: 8,\n    color: '#333',\n  },\n  imageContainer: {\n    position: 'relative',\n  },\n  image: {\n    width: '100%',\n    height: 200,\n    borderRadius: 6,\n    backgroundColor: '#f0f0f0',\n  },\n  removeButton: {\n    marginTop: 8,\n    paddingVertical: 8,\n    paddingHorizontal: 12,\n    backgroundColor: '#ff3b30',\n    borderRadius: 6,\n    alignItems: 'center',\n  },\n  removeButtonText: {\n    color: '#fff',\n    fontSize: 14,\n    fontWeight: '600',\n  },\n  imagePicker: {\n    borderWidth: 2,\n    borderColor: '#007AFF',\n    borderStyle: 'dashed',\n    borderRadius: 6,\n    padding: 40,\n    alignItems: 'center',\n    justifyContent: 'center',\n    backgroundColor: '#f9f9f9',\n  },\n  imagePickerText: {\n    fontSize: 16,\n    color: '#007AFF',\n    fontWeight: '600',\n  },\n  input: {\n    borderWidth: 1,\n    borderColor: '#ddd',\n    borderRadius: 6,\n    padding: 12,\n    fontSize: 14,\n    backgroundColor: '#fafafa',\n  },\n  multilineInput: {\n    minHeight: 80,\n    textAlignVertical: 'top',\n  },\n  charCount: {\n    fontSize: 12,\n    color: '#999',\n    marginTop: 4,\n  },\n  hint: {\n    fontSize: 12,\n    color: '#999',\n    marginTop: 4,\n  },\n  paramRow: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 12,\n  },\n  paramField: {\n    flex: 1,\n    marginRight: 8,\n  },\n  paramLabel: {\n    fontSize: 14,\n    fontWeight: '500',\n    marginBottom: 4,\n    color: '#333',\n  },\n  paramInput: {\n    borderWidth: 1,\n    borderColor: '#ddd',\n    borderRadius: 6,\n    padding: 8,\n    fontSize: 14,\n    backgroundColor: '#fafafa',\n  },\n  paramHint: {\n    fontSize: 11,\n    color: '#999',\n    marginTop: 2,\n  },\n  button: {\n    backgroundColor: '#007AFF',\n    padding: 16,\n    borderRadius: 8,\n    alignItems: 'center',\n    marginBottom: 12,\n  },\n  buttonDisabled: {\n    opacity: 0.6,\n  },\n  buttonText: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: '600',\n  },\n  secondaryButton: {\n    backgroundColor: '#f0f0f0',\n  },\n  secondaryButtonText: {\n    color: '#333',\n    fontSize: 16,\n    fontWeight: '600',\n  },\n  infoBox: {\n    backgroundColor: '#e8f4f8',\n    padding: 12,\n    borderRadius: 6,\n    marginBottom: 12,\n  },\n  infoText: {\n    color: '#0066cc',\n    fontSize: 14,\n    fontWeight: '500',\n  },\n  infoSection: {\n    backgroundColor: '#fff',\n    padding: 16,\n    borderRadius: 8,\n    marginBottom: 20,\n  },\n  infoTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n    marginBottom: 12,\n    color: '#333',\n  },\n  infoItem: {\n    fontSize: 13,\n    color: '#666',\n    marginBottom: 8,\n    lineHeight: 18,\n  },\n});\n\nexport default ImageToVideoScreen;\n
