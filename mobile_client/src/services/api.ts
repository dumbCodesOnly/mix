/**\n * API client service for communicating with the backend.\n *\n * This module provides a centralized interface for all API calls,\n * with automatic error handling, retry logic, and request/response interceptors.\n */\n\nimport axios, { AxiosInstance, AxiosError, AxiosResponse } from 'axios';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\ninterface APIConfig {\n  baseURL: string;\n  timeout: number;\n  maxRetries: number;\n  retryDelay: number;\n}\n\ninterface APIError {\n  error: string;\n  message: string;\n  details?: Record<string, unknown>;\n  timestamp: string;\n}\n\ninterface ImageGenerationRequest {\n  prompt: string;\n  model?: string;\n  negative_prompt?: string;\n  height?: number;\n  width?: number;\n  num_inference_steps?: number;\n  guidance_scale?: number;\n}\n\ninterface ImageEditingRequest {\n  image: string;\n  prompt: string;\n  mask?: string;\n  model?: string;\n  negative_prompt?: string;\n  strength?: number;\n  num_inference_steps?: number;\n  guidance_scale?: number;\n}\n\ninterface TTSRequest {\n  text: string;\n  model?: string;\n  speaker_id?: number;\n  speed?: number;\n}\n\ninterface LLMRequest {\n  messages: Array<{\n    role: 'system' | 'user' | 'assistant';\n    content: string;\n  }>;\n  model?: string;\n  max_tokens?: number;\n  temperature?: number;\n  top_p?: number;\n  top_k?: number;\n}\n\ninterface LLMResponse {\n  response: string;\n  model: string;\n  tokens_used?: number;\n  stop_reason?: string;\n}\n\ninterface EmbeddingRequest {\n  text: string;\n  model?: string;\n}\n\ninterface EmbeddingResponse {\n  embedding: number[];\n  dimension: number;\n  model: string;\n  tokens_used?: number;\n}\n\nclass APIClient {\n  private client: AxiosInstance;\n  private config: APIConfig;\n  private requestRetries: Map<string, number> = new Map();\n\n  constructor(\n    baseURL: string = 'http://localhost:8000',\n    timeout: number = 300000, // 5 minutes\n    maxRetries: number = 3,\n    retryDelay: number = 1000\n  ) {\n    this.config = {\n      baseURL,\n      timeout,\n      maxRetries,\n      retryDelay,\n    };\n\n    this.client = axios.create({\n      baseURL: this.config.baseURL,\n      timeout: this.config.timeout,\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n\n    // Add response interceptor for error handling\n    this.client.interceptors.response.use(\n      (response) => response,\n      (error) => this.handleError(error)\n    );\n  }\n\n  /**\n   * Update the backend URL at runtime.\n   */\n  setBaseURL(baseURL: string): void {\n    this.config.baseURL = baseURL;\n    this.client.defaults.baseURL = baseURL;\n  }\n\n  /**\n   * Get the current backend URL.\n   */\n  getBaseURL(): string {\n    return this.config.baseURL;\n  }\n\n  /**\n   * Check if the backend is healthy.\n   */\n  async checkHealth(): Promise<boolean> {\n    try {\n      const response = await this.client.get('/health');\n      return response.status === 200;\n    } catch (error) {\n      console.error('Health check failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Generate an image from a text prompt.\n   */\n  async generateImage(request: ImageGenerationRequest): Promise<Blob> {\n    try {\n      const response = await this.client.post('/api/image', request, {\n        responseType: 'blob',\n      });\n      return response.data as Blob;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Edit an image based on a text prompt.\n   */\n  async editImage(request: ImageEditingRequest): Promise<Blob> {\n    try {\n      const response = await this.client.post('/api/edit-image', request, {\n        responseType: 'blob',\n      });\n      return response.data as Blob;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Convert text to speech.\n   */\n  async textToSpeech(request: TTSRequest): Promise<Blob> {\n    try {\n      const response = await this.client.post('/api/tts', request, {\n        responseType: 'blob',\n      });\n      return response.data as Blob;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Convert speech to text.\n   */\n  async speechToText(\n    audioBlob: Blob,\n    model?: string,\n    language?: string\n  ): Promise<{ text: string; language?: string; confidence?: number; model: string }> {\n    try {\n      const formData = new FormData();\n      formData.append('audio', audioBlob, 'audio.wav');\n      if (model) formData.append('model', model);\n      if (language) formData.append('language', language);\n\n      const response = await this.client.post('/api/stt', formData, {\n        headers: {\n          'Content-Type': 'multipart/form-data',\n        },\n      });\n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Generate text using a language model.\n   */\n  async generateText(request: LLMRequest): Promise<LLMResponse> {\n    try {\n      const response = await this.client.post('/api/llm', request);\n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Generate embeddings for text.\n   */\n  async generateEmbedding(request: EmbeddingRequest): Promise<EmbeddingResponse> {\n    try {\n      const response = await this.client.post('/api/embedding', request);\n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Handle API errors with retry logic.\n   */\n  private async handleError(error: unknown): Promise<never> {\n    if (axios.isAxiosError(error)) {\n      const axiosError = error as AxiosError<APIError>;\n      const requestKey = `${axiosError.config?.method}-${axiosError.config?.url}`;\n      const retries = this.requestRetries.get(requestKey) || 0;\n\n      // Retry on transient errors\n      if (\n        this.isRetryableError(axiosError) &&\n        retries < this.config.maxRetries\n      ) {\n        this.requestRetries.set(requestKey, retries + 1);\n        await this.delay(this.config.retryDelay * Math.pow(2, retries));\n        return this.client.request(axiosError.config!);\n      }\n\n      // Clear retry count on final failure\n      this.requestRetries.delete(requestKey);\n\n      const errorData = axiosError.response?.data as APIError | undefined;\n      const errorMessage = errorData?.message || axiosError.message || 'Unknown error';\n\n      const error = new Error(errorMessage);\n      (error as any).code = errorData?.error || 'unknown_error';\n      (error as any).details = errorData?.details;\n      (error as any).status = axiosError.response?.status;\n\n      throw error;\n    }\n\n    throw error;\n  }\n\n  /**\n   * Determine if an error is retryable.\n   */\n  private isRetryableError(error: AxiosError): boolean {\n    // Retry on network errors\n    if (!error.response) {\n      return true;\n    }\n\n    // Retry on server errors (5xx)\n    if (error.response.status >= 500) {\n      return true;\n    }\n\n    // Retry on timeout\n    if (error.code === 'ECONNABORTED') {\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Delay execution for a given number of milliseconds.\n   */\n  private delay(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n}\n\n// Global API client instance\nlet apiClient: APIClient | null = null;\n\n/**\n * Get or create the global API client instance.\n */\nexport function getAPIClient(): APIClient {\n  if (!apiClient) {\n    apiClient = new APIClient();\n  }\n  return apiClient;\n}\n\n/**\n * Initialize the API client with a custom base URL.\n */\nexport async function initializeAPIClient(baseURL: string): Promise<void> {\n  apiClient = new APIClient(baseURL);\n  // Save to persistent storage\n  await AsyncStorage.setItem('api_base_url', baseURL);\n}\n\n/**\n * Load the API client with saved base URL.\n */\nexport async function loadAPIClient(): Promise<void> {\n  const savedURL = await AsyncStorage.getItem('api_base_url');\n  if (savedURL) {\n    apiClient = new APIClient(savedURL);\n  } else {\n    apiClient = new APIClient();\n  }\n}\n\nexport default getAPIClient;\nexport type {\n  APIConfig,\n  APIError,\n  ImageGenerationRequest,\n  ImageEditingRequest,\n  TTSRequest,\n  LLMRequest,\n  LLMResponse,\n  EmbeddingRequest,\n  EmbeddingResponse,\n};\n
